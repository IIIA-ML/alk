"""Script to launch experiment with the `ExploitCandidatesIterator` to compare its gain to `TopDownIterator`'s gain.



Examples:
    # Time window width=40, Time window step=1, test size= 1% of the dataset, log level-> console: DEBUG, file: DEBUG
    $ python -m alk.run.run_exploit "~/Dev/alk/datasets/ItalyPowerDemand_TEST.arff" -k 3 -t 0.01 --width 40 --step 1 --logc DEBUG --logf DEBUG

"""

import argparse
import datetime
import logging
import os
import sys
import time

from alk import common
from alk.exp import exploit, ts


logger = logging.getLogger("ALK")


def _create_exp_exploit_engine(dataset, tw_width, tw_step, k, test_size, similarity=None, gen_profile=None):
    """ Creates an 'exploit candidates' iteration experiment engine.

    Returns:
        exploit.ExpExploitEngine:

    """
    # read the dataset -> cb
    cb = ts.gen_cb(dataset=dataset, tw_width=tw_width, tw_step=tw_step, gen_profile=gen_profile)
    # create an experiment engine
    if similarity is None:
        similarity = ts.euclidean_similarity_ts_dataset(dataset)
    engine = exploit.ExpExploitEngine(cb=cb, k=k, similarity=similarity, test_size=test_size)
    return engine


def _parse_args(argv):
    """Helper function that creates a parser and parses the arguments"""

    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)

    parser.add_argument("dataset",
                        help=".arff file for time series dataset")
    parser.add_argument("-k", "--k", type=int,
                        help="k of kNN")
    parser.add_argument("-t", "--testsize", type=float, default=0.01, action="store",
                        help="test size for the dataset")
    parser.add_argument("-w", "--width", type=int, default=0, action="store",
                        help="frame width for cases as moving frames")
    parser.add_argument("-s", "--step", type=int, default=1,
                        help="Number of steps (in terms of data points in TS) taken by the window at each update")
    parser.add_argument("-o", "--outfile",
                        help="File path for experiment results")
    parser.add_argument("-l", "--logfile", type=str,
                        help="Log file path")
    parser.add_argument("--logc", choices=["DEBUG", "INFO"], default="INFO",
                        help="console logger level")
    parser.add_argument("--logf", choices=["DEBUG", "INFO"], default="INFO",
                        help="file logger level")
    # Parse arguments
    args = parser.parse_args(argv)

    return args


def main(argv=None):
    start_time = time.time()
    # add and parse arguments
    args = _parse_args(argv)
    dataset = os.path.expanduser(args.dataset)
    # Generate file names
    out_file = args.outfile if args.outfile else exploit.gen_exploit_output_f_path(dataset, args.width, args.step, args.k, args.testsize)
    log_file = args.logfile if args.logfile else common.gen_log_file(out_file)
    # Set logger
    logger = common.initialize_logger(console_level=args.logc, output_dir=common.APP.FOLDER.LOG, log_file=log_file, file_level=args.logf)
    logger.info("Exploit Candidates Iteration experiment script launched with args: {}".format(str(vars(args))))
    # create the experiment engine
    engine = _create_exp_exploit_engine(dataset, args.width, args.step, args.k, args.testsize)
    # engine.run -> experiment data
    exploit_data = engine.run()
    # create a result obj
    output = exploit.ExpExploitOutput(settings=exploit.ExpExploitSettings(dataset, args.width, args.step, args.k, args.testsize, engine.cb.size()),
                                      data=exploit_data)
    logger.info("Exploit Candidates Iteration experiment finished in {}.".format(datetime.timedelta(seconds=(time.time() - start_time))))
    # save the output
    output.save(out_file=out_file)


if __name__ == '__main__':
    main(sys.argv[1:])
